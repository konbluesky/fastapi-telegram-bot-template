name: CD - Deploy

on:
  push:
    branches: [main]
    tags:
      - "v*" # prod 环境通过 tag 触发 (预留)
  workflow_dispatch:
    inputs:
      environment:
        description: "部署环境"
        required: true
        default: "test"
        type: choice
        options:
          - test
          - prod
      skip_tests:
        description: "跳过测试 (仅紧急情况使用)"
        required: false
        default: false
        type: boolean

env:
  DEPLOY_PATH: /home/ubuntu/work/fastapi-telegram-bot-template
  CONDA_ENV: fastapi-telegram-bot-template
  SERVICE_NAME: fastapi-telegram-bot-template

jobs:
  #  test:
  #    name: Run Tests
  #    runs-on: ubuntu-latest
  #    if: ${{ github.event.inputs.skip_tests != 'true' }}
  #    steps:
  #      - uses: actions/checkout@v4
  #
  #      - name: Install uv
  #        uses: astral-sh/setup-uv@v4
  #        with:
  #          version: "latest"
  #
  #      - name: Set up Python
  #        run: uv python install 3.13
  #
  #      - name: Install dependencies
  #        run: uv sync --all-extras
  #
  #      - name: Run tests
  #        run: uv run pytest tests/ -v --tb=short

  # 确定部署环境
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # 手动触发时使用选择的环境
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          # tag 触发时部署到 prod
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          # push 到 main 部署到 test
          else
            echo "environment=test" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ vars.SERVER_PORT || 22 }} -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Sync files to server
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude 'venv' \
            --exclude '.venv' \
            --exclude '.pytest_cache' \
            --exclude '.ruff_cache' \
            --exclude '*.egg-info' \
            --exclude '.mypy_cache' \
            --exclude 'docs' \
            --exclude 'tests' \
            --exclude 'logs' \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ vars.SERVER_PORT || 22 }}" \
            ./ ${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Setup service and run migration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            cd ${{ env.DEPLOY_PATH }}

            # 设置环境变量
            export APP_ENV=${{ needs.setup.outputs.environment }}

            # 激活 conda 环境
            source ~/miniconda3/etc/profile.d/conda.sh || source ~/anaconda3/etc/profile.d/conda.sh
            conda activate ${{ env.CONDA_ENV }}

            # 安装/更新依赖
            pip install -r requirements.txt

            # 部署 systemd service 文件 (替换环境变量占位符)
            sed "s/__APP_ENV__/${{ needs.setup.outputs.environment }}/g" deploy/${{ env.SERVICE_NAME }}.service | sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }}.service > /dev/null
            sudo systemctl daemon-reload
            sudo systemctl enable ${{ env.SERVICE_NAME }}

            # 执行数据库迁移
            alembic upgrade head

            # 重启服务
            sudo systemctl restart ${{ env.SERVICE_NAME }}

            # 检查服务状态
            sleep 3
            sudo systemctl is-active ${{ env.SERVICE_NAME }}
